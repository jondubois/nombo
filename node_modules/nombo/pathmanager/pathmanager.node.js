var path = require('path');

var PathManager = new (function() {
	var self = this;
	var _frameworkDirPath = null;
	var _frameworkDirRegex = null;
	var _frameworkURL = null;
	var _frameworkURLRegex = null;
	var _appDirPath = null;
	var _appDirRegex = null;
	var _appExternalURL = null;
	var _appExternalURLRegex = null;
	var _appExternalURLShort = null;
	var _multipleSlashesRegex = /(\/|\\)+/g;
	var _trailingSlashRegex = /\/$/;
	var _queryRegex = /[?].*/;
	
	self.toUnixSep = function(filePath) {
		return filePath.replace(/\\/g, '/');
	}
	
	var escapeRegExp = function(str) {
		return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
	}
	
	self.setBaseURL = function(appExternalURL) {
		_appExternalURL = appExternalURL;
		_appExternalURLShort = _appExternalURL.replace(_trailingSlashRegex, '');
		_appExternalURLRegex = new RegExp('^' + escapeRegExp(_appExternalURLShort) + '(\/|$)');
	}
	
	self.init = function(frameworkURL, frameworkDirPath, appDirPath, appExternalURL) {
		_frameworkDirPath = frameworkDirPath;
		_frameworkURL = frameworkURL;
		_frameworkURLRegex = new RegExp('^' + escapeRegExp(_frameworkURL.replace(_trailingSlashRegex, '')) + '(\/|$)');
		_frameworkDirRegex = new RegExp('^' + escapeRegExp(self.toUnixSep(_frameworkDirPath)));
		_appDirPath = appDirPath;
		_appDirRegex = new RegExp('^' + escapeRegExp(self.toUnixSep(_appDirPath)) + '\/?');
		self.setBaseURL(appExternalURL);
	}
	
	self.expand = function(url) {
		if(!_frameworkURLRegex.test(url) && !_appExternalURLRegex.test(url)) {
			return (_appExternalURLShort + url).replace(_multipleSlashesRegex, '/');
		}
		return url;
	}
	
	self.simplify = function(url) {
		return url.replace(_appExternalURLRegex, '/').replace(_multipleSlashesRegex, '/');
	}
	
	self.getFrameworkPath = function() {
		return _frameworkDirPath;
	}
	
	self.getAppPath = function() {
		return _appDirPath;
	}
	
	self.urlToPath = function(url) {
		url = url.replace(_queryRegex, '');
		var filePath;
		if(_frameworkURLRegex.test(url)) {
			filePath = url.replace(_frameworkURLRegex, _frameworkDirPath + '/');
		} else {
			url = self.simplify(url);
			filePath = _appDirPath + url;
		}
		return path.normalize(filePath);
	}
	
	self.pathToURL = function(filePath) {
		filePath = self.toUnixSep(filePath);
		if(_appDirRegex.test(filePath)) {
			return filePath.replace(_appDirRegex, _appExternalURL);
		} else if(_frameworkDirRegex.test(filePath)) {
			return self.toUnixSep(path.normalize(_frameworkURL + filePath.replace(_frameworkDirRegex, '')));
		}
		return filePath;
	}
})();

module.exports = PathManager;

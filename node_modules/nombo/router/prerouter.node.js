var fs = require('fs');
var path = require('path');
var pathManager = require('nombo/pathmanager');

var Prerouter = new (function () {
	var self = this;
	
	self._options = {};
	self._gzipRegex = /\bgzip\b/;
	self._deflateRegex = /\bdeflate\b/;
	
	self.init = function (options) {
		if (options) {
			var i;
			for (i in options) {
				self._options[i] = options[i];
			}
		}
	};
	
	self.run = function (req, res, next) {	
		if (!req.hasOwnProperty('rout')) {
			req.rout = {};
		}
		req.rout._streams = [];
		req.rout.appendStream = function (stream) {
			req.rout._streams.push(stream);
		};
		req.rout.streamCount = function () {
			return req.rout._streams.length;
		};
		req.rout.getLastStream = function () {
			return req.rout._streams[req.rout._streams.length - 1];
		};
		
		if (!req.rout.hasOwnProperty('buffer')) {
			req.rout.buffer = null;
		}
		
		req.rout.filePath = pathManager.urlToPath(req.url);
		
		var encoding = req.headers['accept-encoding'] || '';
			
		if (encoding.match(self._gzipRegex)) {
			req.rout.encoding = 'gzip';
		} else if (encoding.match(self._deflateRegex)) {
			req.rout.encoding = 'deflate';
		} else {
			req.rout.encoding = '';
		}
		
		next();
	};
})();

module.exports = Prerouter;

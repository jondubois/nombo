var fs = require('fs'),
	path = require('path'),
	pathManager = require('nombo/pathmanager'),
	mime = require('mime'),
	less = require('less'),
	wrench = require('wrench'),
	SmartCacheManager = require("nombo/smartcachemanager").SmartCacheManager,
	scriptManager = require('nombo/scriptmanager'),
	crypto = require('crypto'),
	cache = require('nombo/cache');

var HeaderAdder = new (function() {
	var self = this;
	
	self._options = {
		cacheLife: 2592000,
		cacheType: 'private'
	};
	
	self.getOptions = function() {
		return self._options;
	}
	
	self.init = function(options) {
		var i;
		for(i in options) {
			self._options[i] = options[i];
		}
	}
	
	self.run = function(req, res, next) {
		var mimeType;
		
		if(req.rout.mimeType) {
			mimeType = req.rout.mimeType;
		} else {
			mimeType = mime.lookup(req.rout.filePath);
		}
		
		if(req.rout.encoding) {
			encoding = req.rout.encoding;
			res.setHeader('Content-Encoding', encoding);
		} else {
			encoding = cache.ENCODING_PLAIN;
		}
		
		res.setHeader('Content-Type', mimeType);
		res.setHeader('Server', 'Nombo (Node.js)');
		
		if(req.rout.skipCache) {
			res.setHeader('Cache-Control', 'no-cache, must-revalidate');
			res.setHeader('Pragma', 'no-cache');
			next();
		} else if(req.params) {
			var now = new Date();
			var exp = new Date(now.getTime() + self._options.cacheLife * 1000).toUTCString();
			res.setHeader('Cache-Control', self._options.cacheType);
			res.setHeader('Pragma', self._options.cacheType);
			res.setHeader('Expires', exp);
			res.setHeader('ETag', cache.getModifiedTime(encoding, req.url));
			next();
		} else {
			res.setHeader('ETag', cache.getModifiedTime(encoding, req.url));
			next();
		}
	}
})();

module.exports = HeaderAdder;
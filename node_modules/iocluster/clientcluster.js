var async = require('async');

var ClientCluster = function (clients) {
	var client = clients[0];
	
	for(var method in client) {
		(function (method) {
			this[method] = function () {
				var lastArg = arguments[arguments.length - 1];
				
				if (lastArg instanceof Function) {
					var tasks = [];
					var args = Array.prototype.slice.call(arguments, 0, -1);
					var cb = lastArg;
					
					for (var i in clients) {
						tasks.push(function (callback) {
							clients[i][method].apply(clients[i], args.concat(callback))
						});
					}
					async.parallel(tasks, cb);
				} else {
					for (var i in clients) {
						clients[i][method].apply(clients[i], arguments)
					}
				}
			}
		})(method);
	}
};

module.exports.ClientCluster = ClientCluster;
var fs = require('fs'),
	path = require('path'),
	pathManager = require('ncombo/pathmanager'),
	mime = require('mime'),
	less = require('less'),
	wrench = require('wrench'),
	SmartCacheManager = require("ncombo/smartcachemanager").SmartCacheManager,
	scriptManager = require('ncombo/scriptmanager'),
	crypto = require('crypto'),
	cache = require('ncombo/cache');

var HeaderAdder = new (function() {
	var self = this;
	
	self._options = {
		cacheLife: 2592000000,
		cacheType: 'private'
	};
	
	self.getOptions = function() {
		return self._options;
	}
	
	self.init = function(options) {
		var i;
		for(i in options) {
			self._options[i] = options[i];
		}
	}
	
	self.run = function(req, res, next) {
		var mimeType, encoding;
		
		if(req.rout.mimeType) {
			mimeType = req.rout.mimeType;
		} else {
			mimeType = mime.lookup(req.rout.filePath);
		}
		
		if(req.rout.encoding) {
			encoding = req.rout.encoding;
			res.setHeader('Content-Encoding', encoding);
		} else {
			encoding = cache.ENCODING_PLAIN;
		}
		
		res.setHeader('Content-Type', mimeType);
		res.setHeader('Server', 'nCombo (Node.js)');
		
		if(self._options.release && !req.rout.skipCache) {
			var now = new Date();
			var exp = new Date(now.getTime() + self._options.cacheLife).toUTCString();
			
			res.setHeader('Cache-Control', self._options.cacheType);
			res.setHeader('Pragma', self._options.cacheType);
			res.setHeader('Expires', exp);
			
			next();
		} else {
			res.setHeader('Cache-Control', 'no-cache, must-revaliate');
			res.setHeader('Pragma', 'no-cache');
			
			next();
		}
	}
})();

module.exports = HeaderAdder;
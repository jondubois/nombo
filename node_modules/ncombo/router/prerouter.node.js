var fs = require('fs');
var path = require('path');
var pathManager = require('ncombo/pathmanager');

var Prerouter = new (function() {
	var self = this;
	
	self._options = {};
	
	self.init = function(options) {
		if(options) {
			var i;
			for(i in options) {
				self._options[i] = options[i];
			}
		}
	}
	
	self.run = function(req, res, next) {	
		if(!req.hasOwnProperty('rout')) {
			req.rout = {};
		}
		req.rout._streams = [];
		req.rout.appendStream = function(stream) {
			req.rout._streams.push(stream);
		}
		req.rout.streamCount = function() {
			return req.rout._streams.length;
		}
		req.rout.getLastStream = function() {
			return req.rout._streams[req.rout._streams.length - 1];
		}
		
		if(!req.rout.hasOwnProperty('buffer')) {
			req.rout.buffer = null;
		}
		
		req.rout.filePath = pathManager.urlToPath(req.url);
		
		if(self._options.release) {
			var encoding = req.headers['accept-encoding'] || '';
			
			if(encoding.match(/\bgzip\b/)) {
				req.rout.encoding = 'gzip';
			} else if(encoding.match(/\bdeflate\b/)) {
				req.rout.encoding = 'deflate';
			} else {
				req.rout.encoding = '';
			}
		} else {
			req.rout.encoding = '';
			req.params.ck = 1;
		}
		
		next();
	}
})();

module.exports = Prerouter;

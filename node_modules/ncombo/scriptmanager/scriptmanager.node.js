var fs = require('fs');
var path = require('path');
var pathManager = require('ncombo/pathmanager');
var wrench = require('wrench');
var jsp = require("uglify-js").parser;
var pro = require("uglify-js").uglify;

var ScriptManager = function() {
	var self = this;
	
	self._extRegex = /[.][^.]*$/;
	self._frameworkURL = null;
	self._moduleURLRegex = null;
	self._mainScriptURL = null;
	self._mangleArguments = false;
	
	self.setBaseURL = function(appExternalURL) {
		self._moduleURLRegex = new RegExp('^(' + self._frameworkURL + 'client\/|' + appExternalURL + '|\/)?scripts\/');
	}
	
	self.init = function(frameworkURL, appExternalURL, mangleArguments) {
		self._frameworkURL = frameworkURL;
		self._mainScriptURL = '/scripts/index.js';
		self._mangleArguments = mangleArguments;
		self.setBaseURL(appExternalURL);
	}
	
	self.getExtension = function(filePath) {
		var ext = filePath.match(self._extRegex);
		ext = ext ? ext[0] : '';
		return ext;
	}
	
	self.isJSModule = function(url) {
		return self._moduleURLRegex.test(url) && url != self._mainScriptURL;
	}
	
	self.moduleWrap = function(moduleName, code) {
		moduleName = pathManager.expand(moduleName);
		return "(function(exports) { var module = {exports: exports};\n" + code + "\n})($loader._modules['" + moduleName + "']);";
	}
	
	self.minify = function(code) {
		var ast = jsp.parse(code);
		if(self._mangleArguments) {
			ast = pro.ast_mangle(ast);
		}
		ast = pro.ast_squeeze(ast);
		return pro.gen_code(ast);
	}
	
	self.minifyScripts = function(urls, excludeURLs) {
		var i, j, url, dir, files, filePath, curFile, curFileURL, data, ext, ast, ugly, stat;
		var excludeURLMap = {};
		var minifiedMap = {};
		for(i in excludeURLs) {
			excludeURLMap[path.normalize(excludeURLs[i])] = true;
		}
		for(i in urls) {
			url = urls[i];
			filePath = pathManager.urlToPath(url);
			stat = fs.statSync(filePath);
			
			if(stat.isDirectory()) {
				files = wrench.readdirSyncRecursive(filePath);
				
				for(j in files) {
					curFile = filePath + files[j];
					
					if(!excludeURLMap.hasOwnProperty(path.normalize(curFile))) {
						curFileURL = url + files[j];
						ext = curFile.match(self._extRegex);
						ext = ext ? ext[0] : '';
						
						if(ext == '.js') {
							data = fs.readFileSync(curFile);
							if(self.isJSModule(curFileURL)) {
								data = self.moduleWrap(curFileURL, data);
							}
							ast = jsp.parse(data.toString());
							if(self._mangleArguments) {
								ast = pro.ast_mangle(ast);
							}
							ast = pro.ast_squeeze(ast);
							ugly = pro.gen_code(ast);
							minifiedMap[curFileURL] = ugly;
						}
					}
				}
			} else if(stat.isFile() && !excludeURLMap.hasOwnProperty(path.normalize(filePath))) {
				data = fs.readFileSync(filePath);
				if(self.isJSModule(url)) {
					data = self.moduleWrap(url, data);
				}
				ast = jsp.parse(data.toString());
				if(self._mangleArguments) {
					ast = pro.ast_mangle(ast);
				}
				ast = pro.ast_squeeze(ast);
				ugly = pro.gen_code(ast);
				minifiedMap[url] = ugly;
			}
		}
		
		return minifiedMap;
	}
}

module.exports = new ScriptManager();

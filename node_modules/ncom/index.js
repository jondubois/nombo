var net = require('net');
var tls = require('tls');
var crypto = require('crypto');
var formatter = require('./formatter');
var EventEmitter = require('events').EventEmitter;
var domain = require('domain');

var ComSocket = function (options, id) {
	var self = this;
	self._errorDomain = domain.create();
	self._errorDomain.on('error', function (err) {
		self.emit('error', err);
	});
	
	var dataBuffer = '';
	var endSymbol = '\u0017';
	var endSymbolRegex = new RegExp(endSymbol, 'g');
	
	self.id = id;
	
	if (options instanceof net.Socket) {
		self.socket = options;
		self.authorized = options.authorized;
	} else {
		self.socket = new net.Socket(options);
	}
	
	self._errorDomain.add(self.socket);
	
	self.connect = function () {
		self.socket.connect.apply(self.socket, arguments);
	};
	
	self.on = function (event, callback) {
		if (event == 'message') {
			self.socket.on('data', function(data) {
				dataBuffer += data.toString();
				var messages = dataBuffer.split(endSymbol);
				var i;
				var num = messages.length - 1;
				for (i=0; i<num; i++) {
					callback(formatter.parse(messages[i]));
				}
				dataBuffer = messages[num];				
			});
		} else {
			self.socket.on(event, callback);
		}
	};
	
	self.removeListener = function () {
		self.socket.removeListener.apply(self.socket, arguments);
	};
	
	self.removeAllListeners = function () {
		self.socket.removeAllListeners.apply(self.socket, arguments);
	};
	
	self.write = function (data, filters) {
		var str = formatter.stringify(data).replace(endSymbolRegex, '');
		if (filters) {
			var i;
			for (i in filters) {
				str = filters[i](str);
			}
		}
		self.socket.write(str + endSymbol);
	};
	
	self.end = function () {
		self.socket.end();
		self._errorDomain.remove(self.socket);
	};
};

ComSocket.prototype = Object.create(EventEmitter.prototype);

var ComServer = function (options) {
	var self = this;
	
	self._errorDomain = domain.create();
	self._errorDomain.on('error', function (err) {
		self.emit('error', err);
	});
	self._options = options || {};
	
	var server;

	if (self._options.secure) {
		server = tls.createServer(options);
	} else {
		server = net.createServer(options);
	}
	self._errorDomain.add(server);
	
	var idTrailer = 0;
	
	var generateId = function (callback) {
		return crypto.randomBytes(32, function (err, buffer) {
			if (err) {
				callback(null);
			} else {
				idTrailer++;
				callback(buffer.toString('hex') + '-' + idTrailer);
			}
		});
	};
	
	self.listen = function () {
		server.listen.apply(server, arguments);
	};
	
	self.on = function (event, callback) {
		if (event == 'connection') {
			server.on(event, function(socket) {
				generateId(function (id) {
					callback(new ComSocket(socket, id));
				});
			});
		} else {
			server.on(event, callback);
		}
	};
	
	self.removeListener = function () {
		server.removeListener.apply(server, arguments);
	};
	
	self.removeAllListeners = function () {
		server.removeAllListeners.apply(server, arguments);
	};
};

ComServer.prototype = Object.create(EventEmitter.prototype);

var connect = function (options, callback) {
	var engine = options.secure ? tls : net;
	
	var comSocket;
	var socket = engine.connect(options, function () {
		if (comSocket) {
			comSocket.authorized = socket.authorized;
		} else {
			comSocket = new ComSocket(socket);
		}
		callback && callback(comSocket);
	});
	
	if (!comSocket) {
		comSocket = new ComSocket(socket);
	}
	return comSocket;
};

var createServer = function () {
	var options, listener;
	if (arguments[1]) {
		options = arguments[0];
		listener = arguments[1];
	} else if (arguments[0] instanceof Function) {
		listener = arguments[0];
	} else {
		options = arguments[0];
	}
	
	var server = new ComServer(options);
	if (listener) {
		server.on('connection', listener);
	}
	return server;
};

module.exports.ComSocket = ComSocket;
module.exports.ComServer = ComServer;
module.exports.createServer = createServer;
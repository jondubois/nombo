var fs = require('fs'),
	path = require('path'),
	less = require('less'),
	wrench = require('wrench'),
	cache = require('nombo/cache');

var Router = new (function () {
	var self = this;
	self._privateExtension = /$a/;
	
	self.init = function (privateExtensionRegex) {
		self._privateExtension = privateExtensionRegex;
	};
	
	self.run = function (req, res, next) {
		if (req.rout.buffer === null) {
			if (self._privateExtension && self._privateExtension.test(req.rout.filePath)) {
				req.rout.error = true;
				req.rout.status = 403;
				req.rout.buffer = 'The request URL ' + req.url + ' refers to a private resource which cannot be accessed directly.';
				next();
			} else {
				fs.exists(req.rout.filePath, function (exists) {
					if (exists) {
						var fileStream = fs.createReadStream(req.rout.filePath);
						fileStream.on('error', function (err) {
							fileStream.destroy();
						});
						req.rout.appendStream(fileStream);
						next();
					} else {
						req.rout.error = true;
						req.rout.status = 404;
						req.rout.buffer = 'The file at URL ' + req.url + ' does not exist.';
						next();
					}
				});
			}
		} else {
			next();
		}
	};
})();

module.exports = Router;

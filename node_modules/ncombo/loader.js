var EventDispatcher = function() {
	var self = this;
	self._listeners = {};
	
	self.on = function(event, listener) {
		if(!self._listeners.hasOwnProperty(event)) {
			self._listeners[event] = {};
		}
		self._listeners[event][listener] = listener;
	}
	
	self.hasListener = function(event, listener) {
		return self._listeners.hasOwnProperty(event) && self._listeners[event].hasOwnProperty(listener);
	}
	
	self.removeListener = function(event, listener) {
		if(self.willTrigger(event, listener)) {
			delete self._listeners[event][listener];
		}
	}
	
	self.emit = function(event, eventData) {
		if(self._listeners.hasOwnProperty(event)) {
			var eventListeners = self._listeners[event];
			var i;
			for(i in eventListeners) {
				eventListeners[i](eventData);
			}
		}
	}
	
	self.numListeners = function(event) {
		if(self._listeners[event]) {
			var count = 0;
			var i;
			for(i in self._listeners[event]) {
				count++;
			}
			return count;
		}
		return 0;
	}
}

var $loader = {
	_ie: false,
	_ieVersion: null,
	_embedCounter: null,
	
	_loaderStart: null,
	_frameworkURL: null,
	_routToScriptURL: null,
	_cacheVersion: NCOMBO_CACHE_VERSION,
	
	_appDefinition: null,
	_resources: null,
	_resourceIDs: null,
	_resourcesLoaded: null,
	
	_deepResources: null,
	_deepResourcesLoaded: null,
	
	_resourcesLoadedMap: null,
	
	_waitForReadyInterval: null,
	_attempts: null,
	
	_allowLoadAll: null,
	_skipPreload: null,

	ready: function(callback) {
		$loader.on('ready', callback);
		
		if(!$loader._waitForReadyInterval) {
			$loader._waitForReadyInterval = setInterval($loader._waitForReady, 20);
		}
	},
	
	init: function(frameworkURL, routToScriptURL, loadScriptURL, resources, appDefinition, skipPreload) {
		$loader._frameworkURL = frameworkURL;
		$loader._routToScriptURL = routToScriptURL;
		
		$loader._appDefinition = appDefinition;
		
		$loader._resourceIDs = {};
		
		$loader._resources = resources;
		$loader._resources.push($loader._routToScriptURL);
		$loader._resourceIDs[$loader._routToScriptURL] = 'nComboInitScript';
		
		$loader._scriptCodes = {};
		$loader._resourcesLoaded = [];
		$loader._deepResources = {};
		$loader._deepResourcesLoaded = {};
		$loader._resourcesLoadedMap = {};
		$loader._allowLoadAll = true;
		
		$loader._attempts = 0;
		$loader._embedCounter = 0;
		
		if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)) {
			$loader._ie = true;
			$loader._ieVersion = new Number(RegExp.$1)
		}
		
		$loader._skipPreload = skipPreload;
		if(skipPreload) {
			$loader._waitForReadyInterval = setInterval($loader._waitForReady, 20);
		} else {
			$loader.scriptTag(loadScriptURL, 'text/javascript');
		}
	},
	
	getAppDefinition: function() {
		return $loader._appDefinition;
	},
	
	_waitForReady: function() {
		var head = document.getElementsByTagName('head')[0];
		
		if(head && document.body) {
			clearInterval($loader._waitForReadyInterval);
			if($loader._skipPreload) {
				$loader._embedAllResources();
			} else {
				$loader._startLoading();
			}
		}
	},
	
	_startLoading: function() {
		$loader.emit('ready', {frameworkURL: $loader._frameworkURL, resources: $loader._resources});
	},
	
	_globalEval: function(src) {
		if(window.execScript) {
			window.execScript(src);
		} else {
			window.eval.call(window, src);
		}
	},
	
	_embedAllResources: function() {
		if($loader._embedCounter < $loader._resources.length) {
			var url = $loader._resources[$loader._embedCounter];
			var id = $loader._resourceIDs[url];
			var type = null;
			var rel = null;
			
			if(/[.]js$/.test(url)) {
				if($loader._skipPreload) {
					type = 'text/javascript';
					
					$loader.scriptTag(url, type, id, function() {
						$loader._embedCounter++;
						$loader._embedAllResources();
					});
				} else {
					if($loader._scriptCodes[url]) {
						$loader._globalEval($loader._scriptCodes[url]);
						$loader._embedCounter++;
						$loader._embedAllResources();
					}
				}
			} else if(/[.](css|less)$/.test(url)) {
				type = 'text/css';
				if(!rel) {
					rel = 'stylesheet';
				}
				$loader.linkTag(url, type, rel, id);
				$loader._embedCounter++;
				$loader._embedAllResources();
			} else {
				$loader._embedCounter++;
				$loader._embedAllResources();
			}
		}
	},
	
	abortLoadAll: function() {
		$loader._allowLoadAll = false;
	},
	
	loadAll: function() {
		if($loader._allowLoadAll) {
			if($loader._resourcesLoaded.length < $loader._resources.length) {
				$loader._loadDeepResourceToCache($loader._resources[$loader._resourcesLoaded.length], $loader.loadAll, $loader._loadAllFail);
			} else {
				$loader.emit('loadall');
			}
		} else {
			$loader._allowLoadAll = true;
		}
	},
	
	_loadAllFail: function() {
		$loader.emit('loadallfail');
	},
	
	finish: function() {
		$loader._embedAllResources();
	},
	
	ajax: function(settings) {
		var type;
		if(settings.type) {
			type = settings.type;
		} else {
			type = "GET";
		}
	
		var xmlhttp = $loader._getHTTPReqObject();
		xmlhttp.open(type, settings.url, true);
		xmlhttp.onreadystatechange = function() {
			if(xmlhttp.readyState == 4) {
				if(xmlhttp.status == 200) {
					if(settings.success) {
						settings.success(xmlhttp.responseText);
					}
				} else {
					if(settings.error) {
						settings.error(xmlhttp.statusText);
					} else {
						throw "Failed to load resource: " + url;
					}
				}
			}
		}
		xmlhttp.send();
	},
	
	/**
		Insert a script tag into the current document as it is being constructed.
		The id & callback parameters are optional.
	*/
	scriptTag: function(url, type, id, callback) {		
		var head = document.getElementsByTagName('head')[0];
	
		var script = document.createElement('script');
		
		if(callback) {
			if(!$loader._ie || $loader._ieVersion > 8) {
				script.onload = function() {callback(url);};
			} else {
				script.onreadystatechange = function() {
					if(this.readyState == 'complete' || this.readyState == 'loaded') {
						script.onreadystatechange = null;
						callback(url);
					}
				}
			}
		}
		
		if(id) {
			script.id = id;
		}
		script.type = type;
		script.src = smartCacheManager.setURLCacheVersion(url);
		
		head.appendChild(script);
	},
	
	/** 
		Insert a link tag into the current document as it is being constructed.
		The id & callback parameters are optional.
	*/
	linkTag: function(url, type, rel, id) {
		var head = document.getElementsByTagName('head')[0];
		
		var curScripts = document.getElementsByTagName('script');
		var firstScript = null;
		var firstIndex = 0;
		
		if(curScripts) {
			var len = curScripts.length;
			while(firstIndex < len && curScripts[firstIndex].parentNode != head) {
				firstIndex++;
			}
			if(firstIndex < len) {
				firstScript = curScripts[firstIndex];
			}
		}
		
		var link = document.createElement('link');
		
		if(id) {
			link.id = id;
		}
		link.rel = rel;
		link.type = type;
		link.href = smartCacheManager.setURLCacheVersion(url);
		
		if(firstScript) {
			head.insertBefore(link, firstScript);
		} else {
			var curLinks = document.getElementsByTagName('link');
			var lastLink = null;
			var lastIndex = curLinks.length - 1;
			if(curLinks) {
				while(lastIndex >= 0 && curLinks[lastIndex].parentNode != head) {
					lastIndex--;
				}
				if(lastIndex >= 0) {
					lastLink = curLinks[lastIndex];
				}
			}
			
			if(lastLink) {
				if(lastLink.nextSibling) {
					head.insertBefore(link, lastLink.nextSibling);
				} else {
					head.appendChild(link);
				}
			} else {
				head.appendChild(link);
			}
		}
	},
	
	_loadDeepResourceToCache: function(url, successCallback, errorCallback, rootURL) {
		if(!$loader._resourcesLoadedMap[url]) {
			var resourceData = null;
			
			if(!rootURL || url == rootURL) {
				rootURL = url;
				$loader._deepResources[rootURL] = [];
				$loader._deepResources[rootURL].push(url);
				
				$loader._deepResourcesLoaded[rootURL] = [];
			}
			
			if(/[.](png|jpg|gif)$/.test(url)) {
				// images
				var img = new Image();
				img.onload = function() {
					if(url == rootURL) {
						resourceData = img;
					}	
					$loader._resourcesLoadedMap[url] = true;
					$loader._deepResourcesLoaded[rootURL].push(url);
					
					if($loader._deepResourcesLoaded[rootURL].length >= $loader._deepResources[rootURL].length) {
						$loader._resourcesLoaded.push(rootURL);
						if(successCallback) {
							successCallback(rootURL, resourceData);
						}
					}
				};
				
				img.onerror = function() {
					if(errorCallback) {
						errorCallback(url);
					} else {
						throw "Exception: Image failed to load";
					}
				};
				
				img.src = smartCacheManager.setURLCacheVersion(url);
			} else {
				// all text-based files
				$loader.ajax({
					url: smartCacheManager.setURLCacheVersion(url),
					type: "GET",
					success: function(data) {
						if(url == rootURL) {
							resourceData = data;
						}
						
						$loader._resourcesLoadedMap[url] = true;
						$loader._deepResourcesLoaded[rootURL].push(url);
						
						var urls, nonLoadedURLs;
						if(/[.]css$/.test(url)) {
							nonLoadedURLs = [];
							urls = $loader._parseDeepCSSURLs(data, url);
							
							var i, curURL;
							var len = urls.length;
							for(i=0; i<len; i++) {
								curURL = urls[i];
								
								if(!$loader._resourcesLoadedMap[curURL]) {
									$loader._deepResources[rootURL].push(curURL);
									nonLoadedURLs.push(curURL);
								}
							}
							
							len = nonLoadedURLs.length;
							
							for(i=0; i<len; i++) {
								$loader._loadDeepResourceToCache(nonLoadedURLs[i], successCallback, errorCallback, rootURL);
							}
						} else if(/[.]js$/.test(url)) {	
							$loader._scriptCodes[url] = data;
						}
						
						if($loader._deepResourcesLoaded[rootURL].length >= $loader._deepResources[rootURL].length) {
							$loader._resourcesLoaded.push(rootURL);
							if(successCallback) {
								successCallback(rootURL, resourceData);
							}
						}
					},
					
					error: function() {
						if(errorCallback) {
							errorCallback(url);
						} else {
							throw "Exception: One or more resources failed to load";
						}
					}
				});
			}
		}
	},
		
	_parseDeepCSSURLs: function(fileContent, fileURL) {
		var urlMap = {};
		var urls = [];
		var fileDirURL = fileURL.match(/^(.*)\//)[0];
		
		var chuncks = $loader._parseFunctionCalls(fileContent, ['url']);
		
		var imports = fileContent.match(/@import +["'][^"']+["']/g);
		if(imports) {
			chuncks = chuncks.concat(imports);
		}
		
		var isolateURL = /(^url[(][ ]*"?|"?[)]$|^@import[ ]*["']|"$)/g;
		var absolute = /^https?:[/][/]/;
		
		var i, curURL;
		var len = chuncks.length;
		for(i=0; i<len; i++) {
			curURL = chuncks[i].replace(isolateURL, '');
			if(curURL != "" && !urlMap.hasOwnProperty(curURL)) {
				if(!absolute.test(curURL)) {
					urls.push(fileDirURL + curURL);
				} else {
					urls.push(curURL);
				}
				urlMap[curURL] = true;
			}
		}
			
		return urls;
	},
		
	_parseFunctionCalls: function(string, functionNames) {
		var functionCalls = [];
		var functionsRegex = new RegExp('(([^A-Za-z0-9]|^)' + functionNames.join(' *[(]|([^A-Za-z0-9]|^)') + ' *[(])', 'gm');
		var startPos = 0;
		var i, ch, len, curFunc, bt;
		while(true) {
			startPos = string.search(functionsRegex);
			if(startPos < 0) {
				break;
			}
			
			if(string.charAt(startPos) == '(') {
				startPos++;
			}
			
			curFunc = '';
			len = string.length;
			bt = 0;
			for(i=startPos; i<len; i++) {
				ch = string.charAt(i);
				curFunc += ch;
				
				if(ch == '(') {
					bt++;
				} else if(ch == ')') {
					if(--bt == 0) {
						functionCalls.push(curFunc.replace(/^[^A-Za-z0-9]/, ''));
						break;
					}
				}
			}
			string = string.substr(startPos + 2);
		}
		return functionCalls;
	},
	
	_arrayExclude: function(array, excludeArray) {
		var excl = [];
		var mapExcl = {};
		var i;
		var len = excludeArray.length;
		for(i=0; i<len; i++) {
			mapExcl[excludeArray[i]] = true;
		}
		
		len = array.length;
		for(i=0; i<len; i++) {
			if(!mapExcl[array[i]]) {
				excl.push(array[i]);
			}
		}
		return excl;
	},
	
	_getHTTPReqObject: function() {
		var xmlhttp = null;
		
		if($loader._ie) {
			try {
				xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
			} catch (exceptionA) {
				try {
					xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
				} catch (exceptionB) {
					xmlhttp = null;
				}
			}
		}
		
		if (!xmlhttp && typeof XMLHttpRequest != 'undefined') {
			try {
				xmlhttp = new XMLHttpRequest();
			} catch (e) {
				xmlhttp = null;
			}
		}
		
		if(!xmlhttp) {
			throw "Could not instantiate XMLHttpRequest";
		}
		
		return xmlhttp;
	}
}

EventDispatcher.apply($loader);
